---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Aether - Nueva Publicación">
  <div class="max-w-2xl mx-auto pt-4">
    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
      <div class="p-6 border-b border-slate-50 bg-slate-50/50">
        <h1 class="text-xl font-bold text-slate-900">Crear nueva publicación</h1>
        <p class="text-sm text-slate-500 mt-1">Comparte tus ideas con la comunidad</p>
      </div>
      
      <form id="create-post-form" class="p-8 space-y-6">
        <div class="space-y-2">
          <label for="title" class="block text-sm font-medium text-slate-700">Título</label>
          <input 
            type="text" 
            id="title" 
            name="title" 
            required
            class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none transition-all placeholder:text-slate-400"
            placeholder="¿Sobre qué quieres hablar hoy?"
          />
        </div>

        <div class="space-y-2">
          <label for="tag" class="block text-sm font-medium text-slate-700">Comunidad</label>
          <div class="relative">
            <select 
              id="tag" 
              name="tag" 
              class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none transition-all appearance-none cursor-pointer"
            >
              <option value="Tecnología">Tecnología</option>
              <option value="Reflexión">Reflexión</option>
              <option value="Arte">Arte</option>
              <option value="Ciencia">Ciencia</option>
              <option value="Música">Música</option>
            </select>
            <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-slate-500">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
            </div>
          </div>
        </div>

        <div class="space-y-2">
          <label for="content" class="block text-sm font-medium text-slate-700">Contenido</label>
          <textarea 
            id="content" 
            name="content" 
            rows="8" 
            required
            class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none transition-all resize-none placeholder:text-slate-400"
            placeholder="Escribe tu historia aquí..."
          ></textarea>
        </div>

        <div class="pt-4 flex items-center justify-end gap-4">
          <a href="/" class="px-6 py-2.5 text-sm font-medium text-slate-600 hover:text-slate-900 transition-colors">
            Cancelar
          </a>
          <button 
            type="submit" 
            class="bg-indigo-600 text-white font-medium py-2.5 px-8 rounded-full hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-200 hover:shadow-xl hover:-translate-y-0.5 active:translate-y-0 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
          >
            Publicar
          </button>
        </div>
      </form>
    </div>
  </div>
</Layout>

<script>
  // Verificar autenticación
  const token = localStorage.getItem('token');
  if (!token) {
    window.location.href = '/login';
  }

  const form = document.getElementById('create-post-form');
  
  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(form as HTMLFormElement);
      const data = {
        title: formData.get('title'),
        content: formData.get('content'),
        tag: formData.get('tag'),
        author: "temp", // El backend lo sobreescribirá
        created_at: new Date().toISOString().split('T')[0]
      };

      try {
        const response = await fetch('http://127.0.0.1:8000/posts', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(data),
        });

        if (response.ok) {
          window.location.href = '/';
        } else {
          if (response.status === 401) {
            alert('Tu sesión ha expirado. Por favor inicia sesión nuevamente.');
            window.location.href = '/login';
          } else {
            alert('Error al publicar');
          }
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error de conexión');
      }
    });
  }
</script>
