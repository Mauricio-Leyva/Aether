---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Aether - Crear Cuenta">
  <div class="max-w-md mx-auto pt-12">
    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
      <div class="p-8">
        <div class="text-center mb-8">
          <h1 class="text-2xl font-bold text-slate-900">Únete a Aether</h1>
          <p class="text-slate-500 mt-2">Crea tu espacio en nuestra comunidad</p>
        </div>

        <form id="signup-form" class="space-y-6">
          <div class="space-y-2">
            <label for="username" class="block text-sm font-medium text-slate-700">Usuario</label>
            <input 
              type="text" 
              id="username" 
              name="username" 
              required
              class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none transition-all"
              placeholder="Elige un nombre único"
            />
          </div>

          <div class="space-y-2">
            <label for="password" class="block text-sm font-medium text-slate-700">Contraseña</label>
            <input 
              type="password" 
              id="password" 
              name="password" 
              required
              class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none transition-all"
              placeholder="Mínimo 6 caracteres"
            />
          </div>

          <div id="error-message" class="hidden text-red-500 text-sm text-center bg-red-50 p-3 rounded-lg"></div>

          <button 
            type="submit" 
            class="w-full bg-indigo-600 text-white font-medium py-3 rounded-xl hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-200 hover:shadow-xl hover:-translate-y-0.5 active:translate-y-0"
          >
            Crear Cuenta
          </button>
        </form>

        <div class="mt-6 text-center text-sm text-slate-500">
          ¿Ya tienes cuenta? 
          <a href="/login" class="text-indigo-600 font-medium hover:text-indigo-700">Inicia sesión</a>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  const form = document.getElementById('signup-form');
  const errorDiv = document.getElementById('error-message');

  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if(errorDiv) errorDiv.classList.add('hidden');
      
      const formData = new FormData(form as HTMLFormElement);
      const data = {
        username: formData.get('username'),
        password: formData.get('password')
      };

      try {
        const response = await fetch('http://127.0.0.1:8000/register', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data),
        });

        if (response.ok) {
          const result = await response.json();
          localStorage.setItem('token', result.access_token);
          localStorage.setItem('username', data.username as string);
          window.location.href = '/';
        } else {
          const errorData = await response.json();
          if(errorDiv) {
            errorDiv.textContent = errorData.detail || 'Error al registrarse';
            errorDiv.classList.remove('hidden');
          }
        }
      } catch (error) {
        console.error('Error:', error);
        if(errorDiv) {
          errorDiv.textContent = 'Error de conexión';
          errorDiv.classList.remove('hidden');
        }
      }
    });
  }
</script>
